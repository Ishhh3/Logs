<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Transaction Log System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .tab-btn.active { background-color: #1d4ed8; color: #fff; }
    .modal-backdrop { display: none; }
    .modal-backdrop.open { display: flex; }
    .toast { animation: slideIn 0.3s ease, fadeOut 0.5s ease 2.5s forwards; }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes fadeOut { to { opacity: 0; pointer-events: none; } }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">

<!-- TOAST CONTAINER -->
<div id="toastContainer" class="fixed top-5 right-5 z-50 flex flex-col gap-2 pointer-events-none"></div>

<!-- LOGIN PAGE -->
<div id="loginPage" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-900 to-blue-700">
  <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-sm">
    <div class="text-center mb-6">
      <div class="text-4xl mb-2">üñ•Ô∏è</div>
      <h1 class="text-2xl font-bold text-gray-800">Transaction Log</h1>
      <p class="text-gray-500 text-sm">Admin Login</p>
    </div>
    <form id="loginForm" class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
        <input id="loginUsername" type="text" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter username" required />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
        <input id="loginPassword" type="password" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter password" required />
      </div>
      <button type="submit" class="w-full bg-blue-700 hover:bg-blue-800 text-white font-semibold py-2 rounded-lg transition">Login</button>
      <p id="loginError" class="text-red-500 text-sm text-center hidden"></p>
    </form>
    <hr class="my-4" />
    <details class="text-xs text-gray-400">
      <summary class="cursor-pointer">First time? Create admin</summary>
      <div class="mt-2 space-y-2">
        <input id="setupUser" type="text" placeholder="Username" class="w-full border rounded px-3 py-1" />
        <input id="setupPass" type="password" placeholder="Password" class="w-full border rounded px-3 py-1" />
        <button onclick="createAdmin()" class="w-full bg-green-600 text-white py-1 rounded text-xs">Create Admin</button>
        <p id="setupMsg" class="text-center"></p>
      </div>
    </details>
  </div>
</div>

<!-- MAIN APP -->
<div id="mainApp" class="hidden">
  <!-- HEADER -->
  <header class="bg-blue-800 text-white shadow-lg">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="text-2xl">üñ•Ô∏è</span>
        <div>
          <h1 class="font-bold text-lg leading-tight">Transaction Log System</h1>
          <p class="text-blue-200 text-xs">IT Equipment Management</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <span class="text-sm text-blue-200">üë§ <span id="adminName"></span></span>
        <button onclick="logout()" class="bg-red-500 hover:bg-red-600 px-4 py-1 rounded text-sm font-medium transition">Logout</button>
      </div>
    </div>
  </header>

  <!-- TABS -->
  <div class="bg-white shadow-sm sticky top-0 z-20">
    <div class="max-w-7xl mx-auto px-4">
      <nav class="flex gap-1 py-2 overflow-x-auto">
        <button onclick="switchTab('repair')" id="tab-repair" class="tab-btn active px-5 py-2 rounded-lg font-medium text-sm text-gray-600 hover:bg-blue-100 transition whitespace-nowrap">üõ† Repair Log</button>
        <button onclick="switchTab('borrow')" id="tab-borrow" class="tab-btn px-5 py-2 rounded-lg font-medium text-sm text-gray-600 hover:bg-blue-100 transition whitespace-nowrap">üì¶ Borrow Log</button>
        <button onclick="switchTab('pending')" id="tab-pending" class="tab-btn px-5 py-2 rounded-lg font-medium text-sm text-gray-600 hover:bg-blue-100 transition whitespace-nowrap">‚è≥ Pending <span id="pendingBadge" class="bg-red-500 text-white text-xs rounded-full px-1.5 ml-1"></span></button>
        <button onclick="switchTab('history')" id="tab-history" class="tab-btn px-5 py-2 rounded-lg font-medium text-sm text-gray-600 hover:bg-blue-100 transition whitespace-nowrap">üìú History</button>
      </nav>
    </div>
  </div>

  <!-- CONTENT -->
  <main class="max-w-7xl mx-auto px-4 py-6">

    <!-- REPAIR TAB -->
    <div id="tab-repair-content">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold text-gray-800">üõ† Repair Log</h2>
        <button onclick="openModal('receiveModal')" class="bg-blue-700 hover:bg-blue-800 text-white px-4 py-2 rounded-lg text-sm font-medium transition">+ Receive Item</button>
      </div>
      <div class="bg-white rounded-xl shadow overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="bg-gray-50 text-gray-600 uppercase text-xs">
            <tr>
              <th class="px-4 py-3 text-left">ID</th>
              <th class="px-4 py-3 text-left">Office</th>
              <th class="px-4 py-3 text-left">Brought By</th>
              <th class="px-4 py-3 text-left">Product</th>
              <th class="px-4 py-3 text-left">Qty</th>
              <th class="px-4 py-3 text-left">Problem</th>
              <th class="px-4 py-3 text-left">Received By</th>
              <th class="px-4 py-3 text-left">Contact</th>
              <th class="px-4 py-3 text-left">Date</th>
              <th class="px-4 py-3 text-left">Status</th>
              <th class="px-4 py-3 text-left">Actions</th>
            </tr>
          </thead>
          <tbody id="repairTableBody" class="divide-y divide-gray-100 text-gray-700"></tbody>
        </table>
        <div id="repairEmpty" class="hidden text-center py-10 text-gray-400">No repair records found.</div>
      </div>
    </div>

    <!-- BORROW TAB -->
    <div id="tab-borrow-content" class="hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold text-gray-800">üì¶ Borrow Log</h2>
        <button onclick="openModal('borrowModal')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition">+ New Borrow</button>
      </div>
      <div class="bg-white rounded-xl shadow overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="bg-gray-50 text-gray-600 uppercase text-xs">
            <tr>
              <th class="px-4 py-3 text-left">ID</th>
              <th class="px-4 py-3 text-left">Borrower</th>
              <th class="px-4 py-3 text-left">Released By</th>
              <th class="px-4 py-3 text-left">Item</th>
              <th class="px-4 py-3 text-left">Qty</th>
              <th class="px-4 py-3 text-left">Borrow Date</th>
              <th class="px-4 py-3 text-left">Status</th>
              <th class="px-4 py-3 text-left">Actions</th>
            </tr>
          </thead>
          <tbody id="borrowTableBody" class="divide-y divide-gray-100 text-gray-700"></tbody>
        </table>
        <div id="borrowEmpty" class="hidden text-center py-10 text-gray-400">No borrow records found.</div>
      </div>
    </div>

    <!-- PENDING TAB -->
    <div id="tab-pending-content" class="hidden">
      <h2 class="text-xl font-bold text-gray-800 mb-4">‚è≥ Pending Items</h2>
      <div class="bg-white rounded-xl shadow overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="bg-gray-50 text-gray-600 uppercase text-xs">
            <tr>
              <th class="px-4 py-3 text-left">ID</th>
              <th class="px-4 py-3 text-left">Type</th>
              <th class="px-4 py-3 text-left">Details</th>
              <th class="px-4 py-3 text-left">Status</th>
              <th class="px-4 py-3 text-left">Date</th>
              <th class="px-4 py-3 text-left">Actions</th>
            </tr>
          </thead>
          <tbody id="pendingTableBody" class="divide-y divide-gray-100 text-gray-700"></tbody>
        </table>
        <div id="pendingEmpty" class="hidden text-center py-10 text-gray-400">No pending items.</div>
      </div>
    </div>

    <!-- HISTORY TAB -->
    <div id="tab-history-content" class="hidden">
      <h2 class="text-xl font-bold text-gray-800 mb-4">üìú History</h2>
      <div class="bg-white rounded-xl shadow overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="bg-gray-50 text-gray-600 uppercase text-xs">
            <tr>
              <th class="px-4 py-3 text-left">ID</th>
              <th class="px-4 py-3 text-left">Type</th>
              <th class="px-4 py-3 text-left">Details</th>
              <th class="px-4 py-3 text-left">Completed Date</th>
              <th class="px-4 py-3 text-left">Actions</th>
            </tr>
          </thead>
          <tbody id="historyTableBody" class="divide-y divide-gray-100 text-gray-700"></tbody>
        </table>
        <div id="historyEmpty" class="hidden text-center py-10 text-gray-400">No history records yet.</div>
      </div>
    </div>
  </main>
</div>

<!-- ============================================================ -->
<!-- MODALS -->
<!-- ============================================================ -->

<!-- RECEIVE MODAL -->
<div id="receiveModal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 z-30 items-center justify-center p-4">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
    <div class="p-6">
      <div class="flex justify-between items-center mb-5">
        <h3 class="text-lg font-bold text-gray-800">üì• Receive Item for Repair</h3>
        <button onclick="closeModal('receiveModal')" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
      </div>
      <form id="receiveForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="md:col-span-2">
          <label class="form-label">Office Name *</label>
          <input name="office_name" type="text" class="form-input" placeholder="e.g. Mayor's Office" required />
        </div>
        <div>
          <label class="form-label">Person Who Brought Item *</label>
          <input name="brought_by_name" type="text" class="form-input" placeholder="Full name" required />
        </div>
        <div>
          <label class="form-label">Role</label>
          <select name="brought_by_role" class="form-input">
            <option value="Employee">Employee</option>
            <option value="OJT">OJT</option>
            <option value="Office Representative">Office Representative</option>
          </select>
        </div>
        <div>
          <label class="form-label">Product Name *</label>
          <input name="product_name" type="text" class="form-input" placeholder="e.g. Dell Laptop" required />
        </div>
        <div>
          <label class="form-label">Quantity *</label>
          <input name="quantity" type="number" min="1" value="1" class="form-input" required />
        </div>
        <div>
          <label class="form-label">Serial Number</label>
          <input name="serial_number" type="text" class="form-input" placeholder="Optional" />
        </div>
        <div>
          <label class="form-label">Model Number</label>
          <input name="model_number" type="text" class="form-input" placeholder="Optional" />
        </div>
        <div class="md:col-span-2">
          <label class="form-label">Problem Description</label>
          <textarea name="problem_description" class="form-input" rows="2" placeholder="Describe the issue..."></textarea>
        </div>
        <div>
          <label class="form-label">Received By *</label>
          <input name="received_by_name" type="text" class="form-input" placeholder="Full name" required />
        </div>
        <div>
          <label class="form-label">Role</label>
          <select name="received_by_role" class="form-input">
            <option value="Employee">Employee</option>
            <option value="OJT">OJT</option>
          </select>
        </div>
        <div>
          <label class="form-label">Contact Number</label>
          <input name="contact_number" type="text" class="form-input" placeholder="Optional" />
        </div>
        <div>
          <label class="form-label">Date *</label>
          <input name="receive_date" type="date" class="form-input" required />
        </div>
        <div class="md:col-span-2 flex gap-3 justify-end pt-2">
          <button type="button" onclick="closeModal('receiveModal')" class="px-5 py-2 rounded-lg border text-gray-600 hover:bg-gray-100">Cancel</button>
          <button type="submit" class="px-5 py-2 rounded-lg bg-blue-700 text-white hover:bg-blue-800 font-medium">Submit</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- REPAIR MODAL -->
<div id="repairModal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 z-30 items-center justify-center p-4">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg">
    <div class="p-6">
      <div class="flex justify-between items-center mb-5">
        <h3 class="text-lg font-bold text-gray-800">üîß Repair Details</h3>
        <button onclick="closeModal('repairModal')" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
      </div>
      <input type="hidden" id="repairTxId" />
      <form id="repairForm" class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="form-label">Repair Person *</label>
            <input name="repair_person_name" type="text" class="form-input" placeholder="Full name" required />
          </div>
          <div>
            <label class="form-label">Role</label>
            <select name="repair_person_role" class="form-input">
              <option value="Employee">Employee</option>
              <option value="OJT">OJT</option>
            </select>
          </div>
          <div>
            <label class="form-label">Repair Date *</label>
            <input name="repair_date" type="date" class="form-input" required />
          </div>
          <div>
            <label class="form-label">Status *</label>
            <select name="repair_status" class="form-input" required>
              <option value="Fixed">Fixed</option>
              <option value="Unserviceable">Unserviceable</option>
            </select>
          </div>
        </div>
        <div>
          <label class="form-label">Comment</label>
          <textarea name="comment" class="form-input" rows="2" placeholder="Additional notes..."></textarea>
        </div>
        <div class="flex gap-3 justify-end pt-2">
          <button type="button" onclick="closeModal('repairModal')" class="px-5 py-2 rounded-lg border text-gray-600 hover:bg-gray-100">Cancel</button>
          <button type="submit" class="px-5 py-2 rounded-lg bg-orange-600 text-white hover:bg-orange-700 font-medium">Save Repair</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- RELEASE MODAL -->
<div id="releaseModal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 z-30 items-center justify-center p-4">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg">
    <div class="p-6">
      <div class="flex justify-between items-center mb-5">
        <h3 class="text-lg font-bold text-gray-800">üì§ Release Item</h3>
        <button onclick="closeModal('releaseModal')" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
      </div>
      <input type="hidden" id="releaseTxId" />
      <form id="releaseForm" class="space-y-4">
        <div>
          <label class="form-label">Received By (Claiming Person) *</label>
          <input name="released_to_name" type="text" class="form-input" placeholder="Full name" required />
        </div>
        <div>
          <label class="form-label">Released By *</label>
          <input name="released_by_name" type="text" class="form-input" placeholder="Full name" required />
        </div>
        <div>
          <label class="form-label">Release Date *</label>
          <input name="release_date" type="date" class="form-input" required />
        </div>
        <div class="flex gap-3 justify-end pt-2">
          <button type="button" onclick="closeModal('releaseModal')" class="px-5 py-2 rounded-lg border text-gray-600 hover:bg-gray-100">Cancel</button>
          <button type="submit" class="px-5 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700 font-medium">Release</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- BORROW MODAL -->
<div id="borrowModal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 z-30 items-center justify-center p-4">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg">
    <div class="p-6">
      <div class="flex justify-between items-center mb-5">
        <h3 class="text-lg font-bold text-gray-800">üì¶ New Borrow Transaction</h3>
        <button onclick="closeModal('borrowModal')" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
      </div>
      <form id="borrowForm" class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="form-label">Borrower Name *</label>
            <input name="borrower_name" type="text" class="form-input" placeholder="Full name" required />
          </div>
          <div>
            <label class="form-label">Released By *</label>
            <input name="released_by_name" type="text" class="form-input" placeholder="Full name" required />
          </div>
          <div>
            <label class="form-label">Item Name *</label>
            <input name="item_name" type="text" class="form-input" placeholder="e.g. Projector" required />
          </div>
          <div>
            <label class="form-label">Quantity *</label>
            <input name="quantity" type="number" min="1" value="1" class="form-input" required />
          </div>
          <div class="col-span-2">
            <label class="form-label">Borrow Date *</label>
            <input name="borrow_date" type="date" class="form-input" required />
          </div>
        </div>
        <div class="flex gap-3 justify-end pt-2">
          <button type="button" onclick="closeModal('borrowModal')" class="px-5 py-2 rounded-lg border text-gray-600 hover:bg-gray-100">Cancel</button>
          <button type="submit" class="px-5 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700 font-medium">Submit</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- RETURN MODAL -->
<div id="returnModal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 z-30 items-center justify-center p-4">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md">
    <div class="p-6">
      <div class="flex justify-between items-center mb-5">
        <h3 class="text-lg font-bold text-gray-800">‚Ü©Ô∏è Return Item</h3>
        <button onclick="closeModal('returnModal')" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
      </div>
      <input type="hidden" id="returnBorrowId" />
      <form id="returnForm" class="space-y-4">
        <div>
          <label class="form-label">Borrower Name *</label>
          <input name="borrower_name_display" type="text" class="form-input bg-gray-50" readonly />
        </div>
        <div>
          <label class="form-label">Person Who Received Returned Item *</label>
          <input name="received_by_name" type="text" class="form-input" placeholder="Full name" required />
        </div>
        <div>
          <label class="form-label">Return Date *</label>
          <input name="return_date" type="date" class="form-input" required />
        </div>
        <div class="flex gap-3 justify-end pt-2">
          <button type="button" onclick="closeModal('returnModal')" class="px-5 py-2 rounded-lg border text-gray-600 hover:bg-gray-100">Cancel</button>
          <button type="submit" class="px-5 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 font-medium">Confirm Return</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- VIEW MODAL -->
<div id="viewModal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 z-30 items-center justify-center p-4">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
    <div class="p-6">
      <div class="flex justify-between items-center mb-5">
        <h3 class="text-lg font-bold text-gray-800" id="viewModalTitle">Record Details</h3>
        <button onclick="closeModal('viewModal')" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
      </div>
      <div id="viewModalContent" class="space-y-3 text-sm text-gray-700"></div>
      <div class="mt-5 flex justify-end">
        <button onclick="closeModal('viewModal')" class="px-5 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- DELETE CONFIRM MODAL -->
<div id="deleteModal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 z-40 items-center justify-center p-4">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6">
    <h3 class="text-lg font-bold text-gray-800 mb-2">üóëÔ∏è Confirm Delete</h3>
    <p class="text-gray-500 text-sm mb-4">Please enter admin password to confirm deletion.</p>
    <input id="deleteAdminPassword" type="password" class="form-input w-full mb-4" placeholder="Admin password" />
    <div class="flex gap-3 justify-end">
      <button onclick="closeModal('deleteModal')" class="px-5 py-2 rounded-lg border text-gray-600 hover:bg-gray-100">Cancel</button>
      <button id="confirmDeleteBtn" class="px-5 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 font-medium">Delete</button>
    </div>
  </div>
</div>

<style>
  .form-label { display: block; font-size: 0.8rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem; }
  .form-input { width: 100%; border: 1px solid #d1d5db; border-radius: 0.5rem; padding: 0.5rem 0.75rem; font-size: 0.875rem; outline: none; }
  .form-input:focus { ring: 2px; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59,130,246,0.2); }
  .status-pill { display: inline-block; padding: 2px 10px; border-radius: 9999px; font-size: 0.7rem; font-weight: 600; }
  .status-Received { background: #dbeafe; color: #1d4ed8; }
  .status-Repaired { background: #fef3c7; color: #d97706; }
  .status-Released { background: #d1fae5; color: #059669; }
  .status-Borrowed { background: #ede9fe; color: #7c3aed; }
  .status-Returned { background: #d1fae5; color: #059669; }
</style>

<script>
// ============================================================
// STATE
// ============================================================
let repairs = [];
let borrows = [];
let currentDeleteCallback = null;
let currentTab = 'repair';

// ============================================================
// INIT
// ============================================================
document.addEventListener('DOMContentLoaded', async () => {
  setDefaultDates();
  const me = await api('/api/me');
  if (me.loggedIn) {
    showApp(me.username);
    loadAll();
  } else {
    showLogin();
  }
});

function setDefaultDates() {
  const today = new Date().toISOString().split('T')[0];
  document.querySelectorAll('input[type="date"]').forEach(el => el.value = today);
}

function showApp(username) {
  document.getElementById('loginPage').classList.add('hidden');
  document.getElementById('mainApp').classList.remove('hidden');
  document.getElementById('adminName').textContent = username;
}

function showLogin() {
  document.getElementById('loginPage').classList.remove('hidden');
  document.getElementById('mainApp').classList.add('hidden');
}

// ============================================================
// API HELPER
// ============================================================
async function api(url, method = 'GET', body = null) {
  const opts = { method, headers: { 'Content-Type': 'application/json' } };
  if (body) opts.body = JSON.stringify(body);
  const res = await fetch(url, opts);
  return res.json();
}

// ============================================================
// AUTH
// ============================================================
document.getElementById('loginForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const username = document.getElementById('loginUsername').value;
  const password = document.getElementById('loginPassword').value;
  const res = await api('/login', 'POST', { username, password });
  if (res.success) {
    showApp(username);
    loadAll();
  } else {
    const err = document.getElementById('loginError');
    err.textContent = res.message;
    err.classList.remove('hidden');
  }
});

async function logout() {
  await api('/logout', 'POST');
  showLogin();
}

async function createAdmin() {
  const username = document.getElementById('setupUser').value;
  const password = document.getElementById('setupPass').value;
  const res = await api('/api/setup', 'POST', { username, password });
  const msg = document.getElementById('setupMsg');
  msg.textContent = res.message;
  msg.className = res.success ? 'text-green-600 text-xs' : 'text-red-500 text-xs';
}

// ============================================================
// TAB SWITCHING
// ============================================================
function switchTab(tab) {
  currentTab = tab;
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(`tab-${tab}`).classList.add('active');
  ['repair','borrow','pending','history'].forEach(t => {
    document.getElementById(`tab-${t}-content`).classList.toggle('hidden', t !== tab);
  });
  if (tab === 'pending') renderPending();
  if (tab === 'history') renderHistory();
}

// ============================================================
// LOAD DATA
// ============================================================
async function loadAll() {
  const [repairRes, borrowRes] = await Promise.all([
    api('/api/repairs'),
    api('/api/borrows')
  ]);
  if (repairRes.success) repairs = repairRes.data;
  if (borrowRes.success) borrows = borrowRes.data;
  renderRepairs();
  renderBorrows();
  updatePendingBadge();
}

// ============================================================
// REPAIRS TABLE
// ============================================================
function renderRepairs() {
  const tbody = document.getElementById('repairTableBody');
  const empty = document.getElementById('repairEmpty');
  const all = repairs;
  if (!all.length) { tbody.innerHTML = ''; empty.classList.remove('hidden'); return; }
  empty.classList.add('hidden');
  tbody.innerHTML = all.map(r => `
    <tr class="hover:bg-gray-50">
      <td class="px-4 py-3 font-mono text-xs">#${r.id}</td>
      <td class="px-4 py-3">${esc(r.office_name)}</td>
      <td class="px-4 py-3">${esc(r.brought_by_name)}<br><span class="text-xs text-gray-400">${esc(r.brought_by_role)}</span></td>
      <td class="px-4 py-3">${esc(r.product_name)}<br><span class="text-xs text-gray-400">${esc(r.serial_number||r.model_number||'')}</span></td>
      <td class="px-4 py-3">${r.quantity}</td>
      <td class="px-4 py-3 max-w-xs truncate">${esc(r.problem_description||'')}</td>
      <td class="px-4 py-3">${esc(r.received_by_name)}<br><span class="text-xs text-gray-400">${esc(r.received_by_role)}</span></td>
      <td class="px-4 py-3 text-xs">${esc(r.contact_number||'')}</td>
      <td class="px-4 py-3 text-xs">${fmtDate(r.receive_date)}</td>
      <td class="px-4 py-3"><span class="status-pill status-${r.status}">${r.status}</span></td>
      <td class="px-4 py-3">
        <div class="flex gap-1 flex-wrap">
          ${r.status === 'Received' ? `<button onclick="openRepairModal(${r.id})" class="btn-sm bg-orange-500 text-white">Repair</button>` : ''}
          ${r.status === 'Repaired' ? `<button onclick="openReleaseModal(${r.id})" class="btn-sm bg-green-500 text-white">Release</button>` : ''}
          <button onclick="openViewRepair(${r.id})" class="btn-sm bg-gray-200 text-gray-700">View</button>
          <button onclick="confirmDelete('repair', ${r.id})" class="btn-sm bg-red-100 text-red-600">Del</button>
        </div>
      </td>
    </tr>
  `).join('');
}

// ============================================================
// BORROWS TABLE
// ============================================================
function renderBorrows() {
  const tbody = document.getElementById('borrowTableBody');
  const empty = document.getElementById('borrowEmpty');
  if (!borrows.length) { tbody.innerHTML = ''; empty.classList.remove('hidden'); return; }
  empty.classList.add('hidden');
  tbody.innerHTML = borrows.map(b => `
    <tr class="hover:bg-gray-50">
      <td class="px-4 py-3 font-mono text-xs">#${b.id}</td>
      <td class="px-4 py-3">${esc(b.borrower_name)}</td>
      <td class="px-4 py-3">${esc(b.released_by_name)}</td>
      <td class="px-4 py-3">${esc(b.item_name)}</td>
      <td class="px-4 py-3">${b.quantity}</td>
      <td class="px-4 py-3 text-xs">${fmtDate(b.borrow_date)}</td>
      <td class="px-4 py-3"><span class="status-pill status-${b.status}">${b.status}</span></td>
      <td class="px-4 py-3">
        <div class="flex gap-1 flex-wrap">
          ${b.status === 'Borrowed' ? `<button onclick="openReturnModal(${b.id}, '${esc(b.borrower_name)}')" class="btn-sm bg-blue-500 text-white">Return</button>` : ''}
          <button onclick="openViewBorrow(${b.id})" class="btn-sm bg-gray-200 text-gray-700">View</button>
          <button onclick="confirmDelete('borrow', ${b.id})" class="btn-sm bg-red-100 text-red-600">Del</button>
        </div>
      </td>
    </tr>
  `).join('');
}

// ============================================================
// PENDING TABLE
// ============================================================
function renderPending() {
  const tbody = document.getElementById('pendingTableBody');
  const empty = document.getElementById('pendingEmpty');
  const pendingRepairs = repairs.filter(r => r.status === 'Received' || r.status === 'Repaired');
  const pendingBorrows = borrows.filter(b => b.status === 'Borrowed');

  const allPending = [
    ...pendingRepairs.map(r => ({
      id: r.id, type: 'Repair', label: r.status === 'Received' ? 'Awaiting Repair' : 'Awaiting Release',
      details: `${esc(r.product_name)} ‚Äî ${esc(r.office_name)}`,
      status: r.status, date: r.receive_date, raw: r, kind: 'repair'
    })),
    ...pendingBorrows.map(b => ({
      id: b.id, type: 'Borrow', label: 'Borrowed',
      details: `${esc(b.item_name)} (x${b.quantity}) ‚Äî ${esc(b.borrower_name)}`,
      status: b.status, date: b.borrow_date, raw: b, kind: 'borrow'
    }))
  ];

  if (!allPending.length) { tbody.innerHTML = ''; empty.classList.remove('hidden'); return; }
  empty.classList.add('hidden');

  tbody.innerHTML = allPending.map(p => `
    <tr class="hover:bg-gray-50">
      <td class="px-4 py-3 font-mono text-xs">#${p.id}</td>
      <td class="px-4 py-3">
        <span class="status-pill ${p.type === 'Repair' ? 'bg-blue-100 text-blue-700' : 'bg-purple-100 text-purple-700'}">${p.type}</span>
      </td>
      <td class="px-4 py-3">${p.details}</td>
      <td class="px-4 py-3"><span class="status-pill status-${p.status}">${p.label}</span></td>
      <td class="px-4 py-3 text-xs">${fmtDate(p.date)}</td>
      <td class="px-4 py-3">
        <div class="flex gap-1 flex-wrap">
          ${p.kind === 'repair' && p.status === 'Received' ? `<button onclick="openRepairModal(${p.id})" class="btn-sm bg-orange-500 text-white">Repair</button>` : ''}
          ${p.kind === 'repair' && p.status === 'Repaired' ? `<button onclick="openReleaseModal(${p.id})" class="btn-sm bg-green-500 text-white">Release</button>` : ''}
          ${p.kind === 'borrow' ? `<button onclick="openReturnModal(${p.id}, '${p.raw.borrower_name}')" class="btn-sm bg-blue-500 text-white">Return</button>` : ''}
        </div>
      </td>
    </tr>
  `).join('');
}

// ============================================================
// HISTORY TABLE
// ============================================================
function renderHistory() {
  const tbody = document.getElementById('historyTableBody');
  const empty = document.getElementById('historyEmpty');
  const released = repairs.filter(r => r.status === 'Released');
  const returned = borrows.filter(b => b.status === 'Returned');

  const all = [
    ...released.map(r => ({
      id: r.id, type: 'Repair', kind: 'repair',
      details: `${esc(r.product_name)} ‚Äî ${esc(r.office_name)}`,
      date: r.release_date, raw: r
    })),
    ...returned.map(b => ({
      id: b.id, type: 'Borrow', kind: 'borrow',
      details: `${esc(b.item_name)} ‚Äî ${esc(b.borrower_name)}`,
      date: b.return_date, raw: b
    }))
  ];

  if (!all.length) { tbody.innerHTML = ''; empty.classList.remove('hidden'); return; }
  empty.classList.add('hidden');

  tbody.innerHTML = all.map(h => `
    <tr class="hover:bg-gray-50">
      <td class="px-4 py-3 font-mono text-xs">#${h.id}</td>
      <td class="px-4 py-3">
        <span class="status-pill ${h.type === 'Repair' ? 'bg-blue-100 text-blue-700' : 'bg-purple-100 text-purple-700'}">${h.type}</span>
      </td>
      <td class="px-4 py-3">${h.details}</td>
      <td class="px-4 py-3 text-xs">${fmtDate(h.date)}</td>
      <td class="px-4 py-3">
        <div class="flex gap-1">
          <button onclick="${h.kind === 'repair' ? `openViewRepair(${h.id})` : `openViewBorrow(${h.id})`}" class="btn-sm bg-gray-200 text-gray-700">View</button>
          <button onclick="confirmDelete('${h.kind}', ${h.id})" class="btn-sm bg-red-100 text-red-600">Del</button>
        </div>
      </td>
    </tr>
  `).join('');
}

function updatePendingBadge() {
  const count = repairs.filter(r => r.status !== 'Released').length + borrows.filter(b => b.status === 'Borrowed').length;
  const badge = document.getElementById('pendingBadge');
  badge.textContent = count > 0 ? count : '';
}

// ============================================================
// RECEIVE FORM
// ============================================================
document.getElementById('receiveForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const data = formToObj(e.target);
  const res = await api('/api/repairs', 'POST', data);
  if (res.success) {
    toast('Item received and logged!', 'success');
    closeModal('receiveModal');
    e.target.reset();
    setDefaultDates();
    await loadAll();
  } else {
    toast(res.message, 'error');
  }
});

// ============================================================
// REPAIR FORM
// ============================================================
function openRepairModal(id) {
  document.getElementById('repairTxId').value = id;
  openModal('repairModal');
}

document.getElementById('repairForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const id = document.getElementById('repairTxId').value;
  const data = formToObj(e.target);
  const res = await api(`/api/repairs/${id}/repair`, 'PUT', data);
  if (res.success) {
    toast('Repair details saved!', 'success');
    closeModal('repairModal');
    e.target.reset();
    setDefaultDates();
    await loadAll();
    if (currentTab === 'pending') renderPending();
    if (currentTab === 'repair') renderRepairs();
  } else {
    toast(res.message, 'error');
  }
});

// ============================================================
// RELEASE FORM
// ============================================================
function openReleaseModal(id) {
  document.getElementById('releaseTxId').value = id;
  openModal('releaseModal');
}

document.getElementById('releaseForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const id = document.getElementById('releaseTxId').value;
  const data = formToObj(e.target);
  const res = await api(`/api/repairs/${id}/release`, 'PUT', data);
  if (res.success) {
    toast('Item released!', 'success');
    closeModal('releaseModal');
    e.target.reset();
    setDefaultDates();
    await loadAll();
    if (currentTab === 'pending') renderPending();
    if (currentTab === 'history') renderHistory();
  } else {
    toast(res.message, 'error');
  }
});

// ============================================================
// BORROW FORM
// ============================================================
document.getElementById('borrowForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const data = formToObj(e.target);
  const res = await api('/api/borrows', 'POST', data);
  if (res.success) {
    toast('Borrow transaction created!', 'success');
    closeModal('borrowModal');
    e.target.reset();
    setDefaultDates();
    await loadAll();
  } else {
    toast(res.message, 'error');
  }
});

// ============================================================
// RETURN FORM
// ============================================================
function openReturnModal(id, borrowerName) {
  document.getElementById('returnBorrowId').value = id;
  document.querySelector('#returnForm [name="borrower_name_display"]').value = borrowerName;
  openModal('returnModal');
}

document.getElementById('returnForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const id = document.getElementById('returnBorrowId').value;
  const data = formToObj(e.target);
  const res = await api(`/api/borrows/${id}/return`, 'PUT', data);
  if (res.success) {
    toast('Item returned!', 'success');
    closeModal('returnModal');
    e.target.reset();
    setDefaultDates();
    await loadAll();
    if (currentTab === 'pending') renderPending();
    if (currentTab === 'history') renderHistory();
  } else {
    toast(res.message, 'error');
  }
});

// ============================================================
// VIEW MODALS
// ============================================================
function openViewRepair(id) {
  const r = repairs.find(x => x.id === id);
  if (!r) return;
  document.getElementById('viewModalTitle').textContent = `Repair Record #${r.id}`;
  document.getElementById('viewModalContent').innerHTML = viewSection('Receive Details', [
    ['Office', r.office_name],
    ['Brought By', `${r.brought_by_name} (${r.brought_by_role})`],
    ['Product', r.product_name],
    ['Serial/Model', `${r.serial_number||''} / ${r.model_number||''}`],
    ['Quantity', r.quantity],
    ['Problem', r.problem_description],
    ['Received By', `${r.received_by_name} (${r.received_by_role})`],
    ['Contact', r.contact_number],
    ['Date Received', fmtDate(r.receive_date)],
    ['Status', r.status],
  ]) + (r.repair_date ? viewSection('Repair Details', [
    ['Repair Person', `${r.repair_person_name||''} (${r.repair_person_role||''})`],
    ['Repair Date', fmtDate(r.repair_date)],
    ['Repair Status', r.repair_status],
    ['Comment', r.comment],
  ]) : '') + (r.release_date ? viewSection('Release Details', [
    ['Released To', r.released_to_name],
    ['Released By', r.released_by_name],
    ['Release Date', fmtDate(r.release_date)],
  ]) : '');
  openModal('viewModal');
}

function openViewBorrow(id) {
  const b = borrows.find(x => x.id === id);
  if (!b) return;
  document.getElementById('viewModalTitle').textContent = `Borrow Record #${b.id}`;
  document.getElementById('viewModalContent').innerHTML = viewSection('Borrow Details', [
    ['Borrower', b.borrower_name],
    ['Released By', b.released_by_name],
    ['Item', b.item_name],
    ['Quantity', b.quantity],
    ['Borrow Date', fmtDate(b.borrow_date)],
    ['Status', b.status],
  ]) + (b.return_date ? viewSection('Return Details', [
    ['Received By', b.received_by_name],
    ['Return Date', fmtDate(b.return_date)],
  ]) : '');
  openModal('viewModal');
}

function viewSection(title, fields) {
  return `<div class="bg-gray-50 rounded-lg p-4 mb-3">
    <h4 class="font-semibold text-gray-700 mb-3 text-xs uppercase tracking-wide">${title}</h4>
    <div class="grid grid-cols-2 gap-2">
      ${fields.map(([k,v]) => `<div class="text-gray-500">${k}:</div><div class="font-medium">${v||'‚Äî'}</div>`).join('')}
    </div>
  </div>`;
}

// ============================================================
// DELETE
// ============================================================
function confirmDelete(type, id) {
  document.getElementById('deleteAdminPassword').value = '';
  currentDeleteCallback = async () => {
    const password = document.getElementById('deleteAdminPassword').value;
    if (!password) { toast('Enter admin password', 'error'); return; }
    const url = type === 'repair' ? `/api/repairs/${id}` : `/api/borrows/${id}`;
    const res = await api(url, 'DELETE', { adminPassword: password });
    if (res.success) {
      toast('Record deleted.', 'success');
      closeModal('deleteModal');
      await loadAll();
      renderPending();
      renderHistory();
    } else {
      toast(res.message, 'error');
    }
  };
  openModal('deleteModal');
}

document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
  if (currentDeleteCallback) currentDeleteCallback();
});

// ============================================================
// MODAL HELPERS
// ============================================================
function openModal(id) {
  document.getElementById(id).classList.add('open');
}
function closeModal(id) {
  document.getElementById(id).classList.remove('open');
}

// Close modal on backdrop click
document.querySelectorAll('.modal-backdrop').forEach(modal => {
  modal.addEventListener('click', (e) => {
    if (e.target === modal) closeModal(modal.id);
  });
});

// ============================================================
// TOAST
// ============================================================
function toast(msg, type = 'info') {
  const container = document.getElementById('toastContainer');
  const colors = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500' };
  const icons = { success: '‚úÖ', error: '‚ùå', info: '‚ÑπÔ∏è' };
  const div = document.createElement('div');
  div.className = `toast ${colors[type]} text-white px-5 py-3 rounded-xl shadow-lg flex items-center gap-2 min-w-[220px] pointer-events-auto`;
  div.innerHTML = `<span>${icons[type]}</span><span class="text-sm font-medium">${msg}</span>`;
  container.appendChild(div);
  setTimeout(() => div.remove(), 3200);
}

// ============================================================
// UTILS
// ============================================================
function formToObj(form) {
  const data = {};
  new FormData(form).forEach((v, k) => { data[k] = v; });
  return data;
}

function fmtDate(d) {
  if (!d) return '‚Äî';
  return new Date(d).toLocaleDateString('en-PH', { year: 'numeric', month: 'short', day: '2-digit' });
}

function esc(str) {
  if (!str) return '';
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
</script>
</body>
</html>
